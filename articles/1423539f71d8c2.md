---
title: "åŸºäºFastAPIæ„å»º Server-Sent Events API"
emoji: "ğŸ™"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["Python", "FastAPI", "SSE", "ä¸­å›½èª"]
published: true
---

# å‰è¨€

æœ€è¿‘ï¼ŒLLMä¸OpenAIéå¸¸æµè¡Œï¼Œ ç›¸ä¿¡å¾ˆå¤šäººä»Completeå’ŒChat APIä¸­çš„streamæ¨¡å¼ç¬¬ä¸€æ¬¡æ¥è§¦åˆ°äº†SSE APIã€‚SSE(Server-Sent Events)æ˜¯ä¸€ç§æ”¯æŒä»Server Sideå‘Client Sideæ¨é€äº‹ä»¶çš„æ–¹å¼ã€‚å®ƒä¸ä¼ ç»Ÿçš„Restful APIä¸åŒï¼Œä¼ ç»Ÿçš„Restfulæ¶æ„åªèƒ½ä»æœåŠ¡å™¨ç«¯å‘èµ·è¯·æ±‚ï¼Œç„¶åå®¢æˆ·ç«¯è¿”å›å“åº”çš„æ–¹å¼è¿›è¡Œæ•°æ®ä¼ è¾“ã€‚åœ¨éœ€è¦å®æ—¶æ›´æ–°æ•°æ®çš„åœºæ™¯ä¸­ï¼Œåªèƒ½ä¾èµ–è½®è¯¢æˆ–è€…å¼‚æ­¥ä»»åŠ¡æœºåˆ¶æ¥å®ç°ã€‚ä½†å‰è€…æ€§èƒ½ä¸é«˜ï¼Œè€Œåè€…ä¼šå¢åŠ å‰åç«¯æ¶æ„çš„å¤æ‚æ€§ã€‚

WebSocketä¹Ÿæ˜¯ä¸€ä¸ªé€‰æ‹©ï¼Œä½†å®ç°åˆ™æ›´åŠ å¤æ‚ã€‚

å¯¹äºéœ€è¦æœåŠ¡ç«¯ä¸»åŠ¨å‘å®¢æˆ·ç«¯æ¨é€æ¶ˆæ¯ï¼Œè€Œå®¢æˆ·ç«¯ä¸éœ€è¦å‘æœåŠ¡å™¨å‘é€ä¿¡æ¯çš„æƒ…å†µä¸‹ï¼ŒSSEä¼šæ˜¯ä¸€ç§é«˜æ€§èƒ½ä¸”ç®€å•çš„å®ç°æ–¹å¼ã€‚

æœ¬æ–‡ä»‹ç»äº†å¦‚ä½•ä½¿ç”¨pythonå’ŒFastAPIå®ç°SSE APIï¼Œå¹¶ä¸”æ¢è®¨äº†å¦‚ä½•ç»“åˆPydanticä¹¦å†™ç±»å‹å®‰å…¨çš„ä»£ç 

# ä½¿ç”¨`FastAPI`å’Œ`sse-starlette`å®ç°SSE API

[`sse-starlette`](https://github.com/sysid/sse-starlette)åŒ…åŒ…å«äº†SSEçš„å¤§éƒ¨åˆ†å®ç°ã€‚ä»£ç å®ç°éå¸¸ç®€å•ï¼š

https://github.com/akishichinibu/zenn-doc/blob/b5889866383b0a24cf9d2c7bb5a887ff1ede3a51/code/1423539f71d8c2/main.py#L1-L27

åˆ›å»ºä¸€ä¸ªè¿”å›`ServerSentEvent`çš„`AsyncGenerator`ï¼Œç„¶åä½œä¸º`EventSourceResponse`çš„contentè¿”å›å³å¯ã€‚

`ServerSentEvent`çš„ä¸‰ä¸ªå‚æ•°`event`,`id`å’Œ`data`åˆ†åˆ«å¯ä»¥ç”¨æ¥è®¾ç½®æœåŠ¡ç«¯äº‹ä»¶çš„äº‹ä»¶åï¼Œäº‹ä»¶IDå’ŒPayloadçš„å†…å®¹ã€‚

è¾“å‡ºï¼š
```shell

curl -N 'http://127.0.0.1:12345/sse?message=hello'

id: 0
event: echo
data: {'message': 'hello', 'created_at': 1699067601.359488}

id: 1
event: echo
data: {'message': 'hello', 'created_at': 1699067602.36079}

id: 2
event: echo
data: {'message': 'hello', 'created_at': 1699067603.361532}

id: 3
event: echo
data: {'message': 'hello', 'created_at': 1699067604.365153}

id: 4
event: echo
data: {'message': 'hello', 'created_at': 1699067605.367895}

```

# åŸºäºPydanticä¿è¯ç±»å‹å®‰å…¨

åœ¨ä¸Šè¿°ä»£ç ä¸­ï¼Œäº‹ä»¶åä½¿ç”¨äº†å­—é¢é‡ï¼Œè¿”å›æ•°æ®çš„å†…å®¹æ˜¯å­—å…¸ã€‚å½“æ¶‰åŠç®¡ç†å¤æ‚çš„æ•°æ®å†…å®¹ç»“æ„å’Œå¤šä¸ªäº‹ä»¶æ—¶ï¼Œè¿™å¯èƒ½ä¼šå˜å¾—å¾ˆéº»çƒ¦ã€‚è¿™æ—¶å¯ä»¥ç»“åˆPydanticå†™å‡ºæ›´åŠ ç±»å‹å®‰å…¨çš„ä»£ç ã€‚

é¦–å…ˆåˆ›å»ºä¸€ä¸ªæè¿°äº‹ä»¶çš„ç±»`BaseEvent[T]`ï¼Œå®ƒæ ¹æ®ç±»åæ¨æ–­äº‹ä»¶åï¼Œå¹¶åŒ…å«ä¸€ä¸ªç±»å‹ä¸º`T`çš„Payloadã€‚

https://github.com/akishichinibu/zenn-doc/blob/b5889866383b0a24cf9d2c7bb5a887ff1ede3a51/code/1423539f71d8c2/main2.py#L13-L26


ç„¶ååˆ›å»ºä¸€ä¸ªè£…é¥°å™¨ï¼Œå°†`BaseEvent[T]`çš„æµè½¬æ¢ä¸º`ServerSentEvent`ä¸€ä¸ªçš„æµã€‚
https://github.com/akishichinibu/zenn-doc/blob/b5889866383b0a24cf9d2c7bb5a887ff1ede3a51/code/1423539f71d8c2/main2.py#L32-L54


ç„¶åæˆ‘ä»¬å®šä¹‰Echoçš„Payload`EchoPayload`ï¼Œç„¶åå®šä¹‰äº‹ä»¶`Echo`ï¼Œæœ€ååˆ›å»ºäº‹ä»¶æµ`echo_stream2`ã€‚

https://github.com/akishichinibu/zenn-doc/blob/b5889866383b0a24cf9d2c7bb5a887ff1ede3a51/code/1423539f71d8c2/main2.py#L57-L76

```shell
curl -N 'http://127.0.0.1:12345/sse2?message=hello'
id: 0
event: echo
data: {"message":"hello","created_at":"2023-11-04T13:02:10.760797"}

id: 1
event: echo
data: {"message":"hello","created_at":"2023-11-04T13:02:11.762338"}

id: 2
event: echo
data: {"message":"hello","created_at":"2023-11-04T13:02:12.764145"}

id: 3
event: echo
data: {"message":"hello","created_at":"2023-11-04T13:02:13.765405"}

id: 4
event: echo
data: {"message":"hello","created_at":"2023-11-04T13:02:14.765821"}

id: 5
event: echo
data: {"message":"hello","created_at":"2023-11-04T13:02:15.767593"}
```

# å¦‚æœéœ€è¦åœ¨ä¸€ä¸ªAPIä¸­åˆå¹¶å¤šä¸ªæµ

å¯ä»¥è€ƒè™‘ä½¿ç”¨[aiostream](https://github.com/vxgmichel/aiostream)ä¸­çš„[merge](https://aiostream.readthedocs.io/en/latest/operators.html#aiostream.stream.merge)æ“ä½œç¬¦ã€‚

åˆ›å»ºå¦å¤–ä¸€ä¸ªæµ`echo_stream3`å¹¶ä¸”å°†å…¶ä¸`echo_stream2`è¿›è¡Œåˆå¹¶ï¼Œå¯ä»¥çœ‹åˆ°ä¸¤ä¸ªæµäº¤æ›¿è¾“å‡ºã€‚

https://github.com/akishichinibu/zenn-doc/blob/b5889866383b0a24cf9d2c7bb5a887ff1ede3a51/code/1423539f71d8c2/main2.py#L84-L109

```shell
curl -N 'http://127.0.0.1:12345/sse3?message=hello'

id: 0
event: echo
data: {"message":"hello","created_at":"2023-11-04T13:04:26.129152"}

id: 1
event: echo
data: {"message":"hello","created_at":"2023-11-04T13:04:27.130363"}

id: 0
event: reverse_echo
data: {"message":"olleh","created_at":"2023-11-04T13:04:27.130311"}

id: 2
event: echo
data: {"message":"hello","created_at":"2023-11-04T13:04:28.131686"}

id: 1
event: reverse_echo
data: {"message":"olleh","created_at":"2023-11-04T13:04:28.131802"}

id: 3
event: echo
data: {"message":"hello","created_at":"2023-11-04T13:04:29.132987"}

id: 2
event: reverse_echo
data: {"message":"olleh","created_at":"2023-11-04T13:04:29.133048"}

id: 4
event: echo
data: {"message":"hello","created_at":"2023-11-04T13:04:30.133555"}

id: 3
event: reverse_echo
data: {"message":"olleh","created_at":"2023-11-04T13:04:30.133599"}

id: 5
event: echo
data: {"message":"hello","created_at":"2023-11-04T13:04:31.134985"}

id: 4
event: reverse_echo
data: {"message":"olleh","created_at":"2023-11-04T13:04:31.135166"}
```

# æ€»ç»“

æœ¬æ–‡ä»‹ç»äº†å¦‚ä½•ä½¿ç”¨FastAPIå’Œ`sse-starlette`æ„å»ºSSE APIï¼Œå®ç°äº†ä»æœåŠ¡ç«¯å®æ—¶æ¨é€æ•°æ®çš„æ–¹å¼ã€‚æˆ‘ä»¬è¿˜è®¨è®ºäº†å¦‚ä½•é€šè¿‡Pydanticç¡®ä¿ç±»å‹å®‰å…¨ï¼Œæé«˜ä»£ç å¯ç»´æŠ¤æ€§ï¼Œä»¥åŠåœ¨ä¸€ä¸ªAPIä¸­åˆå¹¶å¤šä¸ªæµçš„æ–¹æ³•ã€‚
